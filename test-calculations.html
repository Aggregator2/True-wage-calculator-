<!DOCTYPE html>
<html>
<head>
    <title>Tax Calculation Tests</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .pass { color: green; }
        .fail { color: red; }
        table { border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: right; }
        th { background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>UK Tax Calculation Tests (2025/26)</h1>
    <p>Comparing against known values from TheSalaryCalculator.co.uk and ListenToTaxman</p>

    <div id="results"></div>

    <script>
        // Import tax config (copy from calculator.js for testing) - 2025/26 rates
        const TAX_CONFIG = {
            personalAllowance: 12570,
            personalAllowanceTaperThreshold: 100000,
            england: {
                bands: [
                    { threshold: 12570, rate: 0 },
                    { threshold: 50270, rate: 0.20 },
                    { threshold: 125140, rate: 0.40 },
                    { threshold: Infinity, rate: 0.45 }
                ]
            },
            scotland: {
                bands: [
                    { threshold: 12570, rate: 0 },
                    { threshold: 14921, rate: 0.19 },
                    { threshold: 26861, rate: 0.20 },
                    { threshold: 44605, rate: 0.21 },
                    { threshold: 78149, rate: 0.42 },
                    { threshold: 125140, rate: 0.45 },
                    { threshold: Infinity, rate: 0.48 }
                ]
            },
            nationalInsurance: {
                primaryThreshold: 12570,
                upperEarningsLimit: 50270,
                mainRate: 0.08,
                upperRate: 0.02
            },
            studentLoans: {
                plan1: { threshold: 25375, rate: 0.09 },
                plan2: { threshold: 27660, rate: 0.09 },
                plan4: { threshold: 31395, rate: 0.09 },
                plan5: { threshold: 25000, rate: 0.09 },
                postgrad: { threshold: 21000, rate: 0.06 }
            }
        };

        function calculatePersonalAllowance(grossSalary) {
            if (grossSalary <= TAX_CONFIG.personalAllowanceTaperThreshold) {
                return TAX_CONFIG.personalAllowance;
            }
            const reduction = Math.floor((grossSalary - TAX_CONFIG.personalAllowanceTaperThreshold) / 2);
            return Math.max(0, TAX_CONFIG.personalAllowance - reduction);
        }

        function calculateIncomeTax(taxableIncome, region) {
            const bands = TAX_CONFIG[region].bands;
            let tax = 0;
            let remainingIncome = taxableIncome;
            let previousThreshold = 0;

            for (const band of bands) {
                if (remainingIncome <= 0) break;
                const bandWidth = band.threshold - previousThreshold;
                const taxableInBand = Math.min(remainingIncome, bandWidth);
                tax += taxableInBand * band.rate;
                remainingIncome -= taxableInBand;
                previousThreshold = band.threshold;
            }
            return tax;
        }

        function calculateNI(grossSalary) {
            const ni = TAX_CONFIG.nationalInsurance;
            if (grossSalary <= ni.primaryThreshold) return 0;

            let niContribution = 0;
            const mainRateEarnings = Math.min(grossSalary, ni.upperEarningsLimit) - ni.primaryThreshold;
            niContribution += Math.max(0, mainRateEarnings) * ni.mainRate;

            if (grossSalary > ni.upperEarningsLimit) {
                niContribution += (grossSalary - ni.upperEarningsLimit) * ni.upperRate;
            }
            return niContribution;
        }

        function calculateStudentLoan(grossSalary, planType) {
            if (planType === 'none') return 0;
            const plan = TAX_CONFIG.studentLoans[planType];
            if (!plan || grossSalary <= plan.threshold) return 0;
            return (grossSalary - plan.threshold) * plan.rate;
        }

        // Test cases based on known calculator results
        // Reference: TheSalaryCalculator.co.uk, ListenToTaxman.com
        const testCases = [
            // Format: { salary, region, expectedTax, expectedNI, description }
            { salary: 25000, region: 'england', expectedTax: 2486, expectedNI: 994, description: '£25k England' },
            { salary: 35000, region: 'england', expectedTax: 4486, expectedNI: 1794, description: '£35k England' },
            { salary: 50000, region: 'england', expectedTax: 7486, expectedNI: 2994, description: '£50k England' },
            { salary: 60000, region: 'england', expectedTax: 11500, expectedNI: 3189, description: '£60k England' },
            { salary: 80000, region: 'england', expectedTax: 19500, expectedNI: 3589, description: '£80k England' },
            { salary: 100000, region: 'england', expectedTax: 27500, expectedNI: 3989, description: '£100k England' },
            { salary: 125000, region: 'england', expectedTax: 42500, expectedNI: 4489, description: '£125k England (PA tapered)' },
            { salary: 150000, region: 'england', expectedTax: 53703, expectedNI: 4989, description: '£150k England' },

            // Scottish rates
            { salary: 35000, region: 'scotland', expectedTax: 4774, expectedNI: 1794, description: '£35k Scotland' },
            { salary: 50000, region: 'scotland', expectedTax: 8675, expectedNI: 2994, description: '£50k Scotland' },
            { salary: 80000, region: 'scotland', expectedTax: 21275, expectedNI: 3589, description: '£80k Scotland' },
        ];

        // Run tests
        let html = '<table><tr><th>Test</th><th>Salary</th><th>Expected Tax</th><th>Calculated Tax</th><th>Diff</th><th>Expected NI</th><th>Calculated NI</th><th>Diff</th><th>Status</th></tr>';

        let passCount = 0;
        let failCount = 0;

        testCases.forEach(test => {
            const personalAllowance = calculatePersonalAllowance(test.salary);
            const taxableIncome = Math.max(0, test.salary - personalAllowance);
            const calculatedTax = calculateIncomeTax(test.salary, test.region);
            const calculatedNI = calculateNI(test.salary);

            const taxDiff = Math.abs(calculatedTax - test.expectedTax);
            const niDiff = Math.abs(calculatedNI - test.expectedNI);

            // Allow £10 tolerance for rounding differences
            const taxPass = taxDiff <= 10;
            const niPass = niDiff <= 10;
            const pass = taxPass && niPass;

            if (pass) passCount++; else failCount++;

            html += `<tr>
                <td style="text-align:left">${test.description}</td>
                <td>£${test.salary.toLocaleString()}</td>
                <td>£${test.expectedTax.toLocaleString()}</td>
                <td>£${calculatedTax.toFixed(0)}</td>
                <td class="${taxPass ? 'pass' : 'fail'}">£${taxDiff.toFixed(0)}</td>
                <td>£${test.expectedNI.toLocaleString()}</td>
                <td>£${calculatedNI.toFixed(0)}</td>
                <td class="${niPass ? 'pass' : 'fail'}">£${niDiff.toFixed(0)}</td>
                <td class="${pass ? 'pass' : 'fail'}">${pass ? 'PASS' : 'FAIL'}</td>
            </tr>`;
        });

        html += '</table>';
        html += `<p><strong>Results: ${passCount} passed, ${failCount} failed</strong></p>`;

        // Student loan tests
        html += '<h2>Student Loan Tests</h2>';
        html += '<table><tr><th>Plan</th><th>Salary</th><th>Expected</th><th>Calculated</th><th>Status</th></tr>';

        const slTests = [
            { plan: 'plan1', salary: 35000, expected: 901 }, // (35000-24990) * 0.09
            { plan: 'plan2', salary: 35000, expected: 693 }, // (35000-27295) * 0.09
            { plan: 'plan4', salary: 35000, expected: 324 }, // (35000-31395) * 0.09
            { plan: 'postgrad', salary: 35000, expected: 840 }, // (35000-21000) * 0.06
        ];

        slTests.forEach(test => {
            const calculated = calculateStudentLoan(test.salary, test.plan);
            const diff = Math.abs(calculated - test.expected);
            const pass = diff <= 5;

            html += `<tr>
                <td>${test.plan}</td>
                <td>£${test.salary.toLocaleString()}</td>
                <td>£${test.expected}</td>
                <td>£${calculated.toFixed(0)}</td>
                <td class="${pass ? 'pass' : 'fail'}">${pass ? 'PASS' : 'FAIL'}</td>
            </tr>`;
        });

        html += '</table>';

        // Personal Allowance taper test
        html += '<h2>Personal Allowance Taper Tests</h2>';
        html += '<table><tr><th>Salary</th><th>Expected PA</th><th>Calculated PA</th><th>Status</th></tr>';

        const paTests = [
            { salary: 90000, expectedPA: 12570 },
            { salary: 100000, expectedPA: 12570 },
            { salary: 110000, expectedPA: 7570 },
            { salary: 120000, expectedPA: 2570 },
            { salary: 125140, expectedPA: 0 },
            { salary: 150000, expectedPA: 0 },
        ];

        paTests.forEach(test => {
            const calculated = calculatePersonalAllowance(test.salary);
            const pass = calculated === test.expectedPA;

            html += `<tr>
                <td>£${test.salary.toLocaleString()}</td>
                <td>£${test.expectedPA.toLocaleString()}</td>
                <td>£${calculated.toLocaleString()}</td>
                <td class="${pass ? 'pass' : 'fail'}">${pass ? 'PASS' : 'FAIL'}</td>
            </tr>`;
        });

        html += '</table>';

        document.getElementById('results').innerHTML = html;
    </script>
</body>
</html>
